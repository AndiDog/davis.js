// davis.js JavaScript Routing, version: 0.1.0
// (c) 2011 Oliver Nightingale
//
//  Released under MIT license.
//
Davis=function(c){var e=new Davis.App;c.call(e);return e};
Davis.listener=function(){var c=function(d){return function(b){b=new Davis.Request(d.call($(b.target)));Davis.history.pushState(b);return false}},e=c(function(){return{method:"get",fullPath:this.attr("href"),title:this.attr("title")}}),a=c(function(){return{method:this.attr("method"),fullPath:[this.attr("action"),"?",this.serialize()].join(""),title:this.attr("title")}});return{listen:function(){$(document).delegate(this.settings.formSelector,"submit",a);$(document).delegate(this.settings.linkSelector,
"click",e)},unlisten:function(){$(document).undelegate(this.settings.linkSelector,"click",e);$(document).undelegate(this.settings.formSelector,"submit",a)}}}();Davis.event={_callbacks:{},bind:function(c,e){this._callbacks[c]||(this._callbacks[c]=[]);this._callbacks[c].push(e);return this},trigger:function(c,e){var a=this;this._callbacks[c]||(this._callbacks[c]=[]);this._callbacks[c].forEach(function(d){d.call(a,e)});return this}};
Davis.logger=function(){var c=function(e){e=Array.prototype.slice.call(e);e.unshift("["+Date()+"]");return e};return{error:function(){window.console&&console.error.apply(console,c(arguments))},info:function(){window.console&&console.info.apply(console,c(arguments))},warn:function(){window.console&&console.warn.apply(console,c(arguments))}}}();
Davis.Route=function(){var c=/:([\w\d]+)/g,e=function(a,d,b){this.paramNames=function(){for(var g=[],h;h=c.exec(d);)g.push(h[1]);return g}();var f;f=d instanceof RegExp?d:RegExp("^"+d.replace(c,"([^/]+)")+"$","g");this.path=f;a=a instanceof RegExp?a:RegExp("^"+a+"$");this.method=a;this.callback=b};e.prototype={match:function(a,d){return this.method.test(a)&&this.path.test(d)},run:function(a){this.path.lastIndex=0;var d=this.path.exec(a.path);if(d){d.shift();for(var b=0;b<d.length;b++)a.params[this.paramNames[b]]=
d[b]}this.path.lastIndex=0;return this.callback.call(a,a)},toString:function(){return[this.method,this.path].join(" ")}};return e}();
Davis.router=function(){var c=this;["get","post","put","delete"].forEach(function(e){c[e]=function(a,d){c._routeCollection.push(new Davis.Route(e,a,d))}});["before","after"].forEach(function(e){c[e]=function(){if(arguments.length==1)var d=/.+/,b=arguments[0];else if(arguments.length==2){d=arguments[0];b=arguments[1]}c._filterCollection[e].push(new Davis.Route(/.+/,d,b))};var a="lookup"+e.replace(/^\w/,function(d){return d.toUpperCase()})+"Filter";c[a]=function(d,b){return c._filterCollection[e].filter(function(f){return f.match(d,
b)})}});c._routeCollection=[];c._filterCollection={before:[],after:[]};c.lookupRoute=function(e,a){return this._routeCollection.filter(function(d){return d.match(e,a)})[0]}};
Davis.history=function(){var c=[],e=function(a){return function(d){d.state?a(d.state):a(Davis.Request.forPageLoad())}};return{replaceState:function(a){history.replaceState(a,a.title,a.path);c.forEach(function(d){d(a)})},pushState:function(a){history.pushState(a,a.title,a.path);c.forEach(function(d){d(a)})},onChange:function(a){c.push(a);a=e(a);window.addEventListener("popstate",a)}}}();
Davis.Request=function(c){var e=this;this.params={};this.title=c.title;(this.queryString=c.fullPath.split("?")[1])&&this.queryString.split("&").forEach(function(a){var d=a.split("=")[0];a=a.split("=")[1];var b;if(b=/^(\w+)%5B(\w+)%5D/.exec(d)){var f=b[1];d=b[2];b=e.params[f]||{};b[d]=a;e.params[f]=b}else e.params[d]=a});this.method=this.params._method||c.method;this.path=c.fullPath.replace(/\?.+$/,"")};
Davis.Request.prototype.redirect=function(c){Davis.history.replaceState(new Davis.Request({method:"get",fullPath:c,title:this.title}))};Davis.Request.prototype.toString=function(){return[this.method.toUpperCase(),this.path].join(" ")};Davis.Request.forPageLoad=function(){return new this({method:"get",fullPath:window.location.pathname,title:document.title})};
Davis.App=function(){var c=0,e=function(){this.id=[(new Date).valueOf(),c++].join("-");this.running=false};e.prototype=$.extend({configure:function(a){a.call(this.settings)},settings:{linkSelector:"a",formSelector:"form",logger:Davis.logger},start:function(){var a=this;this.bind("runRoute",function(b){a.settings.logger.info("runRoute: "+b.toString())}).bind("routeNotFound",function(b){a.settings.logger.warn("routeNotFound: "+b.toString())}).bind("start",function(){a.settings.logger.info("application started")});
this.listen();this.trigger("start");var d=function(b){return function(f){f=f.run(b,b);return typeof f==="undefined"||f}};Davis.history.onChange(function(b){if(a.lookupBeforeFilter(b.method,b.path).every(d(b))){a.trigger("lookupRoute",b);var f=a.lookupRoute(b.method,b.path);if(f){a.trigger("runRoute",b);f.run(b);a.lookupAfterFilter(b.method,b.path).every(d(b))}else a.trigger("routeNotFound",b)}else a.trigger("requestHalted",b)});this.running=true},stop:function(){this.unlisten();this.trigger("stop")}},
Davis.listener,Davis.event);Davis.router.call(e.prototype);return e}();
